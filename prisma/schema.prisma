// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BouleNight {
  id          String        @id @default(cuid())
  name        String
  date        DateTime
  location    String?
  description String?
  type        NightType     @default(EVENING)
  maxPlayers  Int?
  rounds      Round[]
  matches     Match[]
  attendance  NightAttendance[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Player {
  id        String   @id @default(cuid())
  name      String

  matchPlayers MatchPlayer[]
  attendance   NightAttendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NightAttendance {
  id        String     @id @default(cuid())

  night     BouleNight @relation(fields: [nightId], references: [id])
  nightId   String

  player    Player     @relation(fields: [playerId], references: [id])
  playerId  String

  present   Boolean    @default(true)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([nightId, playerId], name: "NightAttendance_night_player_unique")
}

model PlayRequest {
  id            String    @id @default(cuid())
  name          String?
  message       String?
  preferredDate DateTime?
  nightId       String?

  createdAt     DateTime  @default(now())
}

model Round {
  id        String      @id @default(cuid())

  night     BouleNight  @relation(fields: [nightId], references: [id])
  nightId   String

  number    Int         // 1, 2, 3

  matches   Match[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model Match {
  id          String       @id @default(cuid())

  night       BouleNight   @relation(fields: [nightId], references: [id])
  nightId     String

  round       Round        @relation(fields: [roundId], references: [id])
  roundId     String

  lane        Int?

  homeScore   Int?
  awayScore   Int?
  status      MatchStatus  @default(SCHEDULED)

  teams       MatchTeam[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model MatchTeam {
  id        String    @id @default(cuid())

  match     Match     @relation(fields: [matchId], references: [id])
  matchId   String

  side      TeamSide

  players   MatchPlayer[]
}

model MatchPlayer {
  id            String      @id @default(cuid())

  matchTeam     MatchTeam   @relation(fields: [matchTeamId], references: [id])
  matchTeamId   String

  player        Player      @relation(fields: [playerId], references: [id])
  playerId      String

  pointsFor     Int         @default(0)
  pointsAgainst Int         @default(0)
  won           Boolean     @default(false)
}

enum MatchStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum TeamSide {
  HOME
  AWAY
}

enum NightType {
  DAY
  EVENING
}
