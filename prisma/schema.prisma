// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
  output        = "../src/generated"
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String?
  favorites Favorite[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Favorite {
  id        String   @id @default(uuid())

  userId    String
  matchId   String?
  playerId  String?
  teamId    String?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  match     Match?   @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player    Player?  @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team      Team?    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, matchId])
  @@unique([userId, playerId])
  @@unique([userId, teamId])
  @@index([userId])
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BouleNight {
  id          String        @id @default(cuid())
  name        String
  date        DateTime
  location    String?
  description String?
  type        NightType     @default(EVENING)
  drawMode    DrawMode      @default(INDIVIDUAL)
  maxPlayers  Int?
  rounds      Round[]
  matches     Match[]
  attendance  NightAttendance[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Player {
  id        String   @id @default(cuid())
  name      String
  isAdmin   Boolean  @default(false)

  matchPlayers MatchPlayer[]
  attendance   NightAttendance[]
  teamMemberships TeamMember[]
  resultConfirmations MatchResultConfirmation[]
  roundByes   RoundBye[]
  ranking    Ranking?
  favorites  Favorite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NightAttendance {
  id        String     @id @default(cuid())

  night     BouleNight @relation(fields: [nightId], references: [id])
  nightId   String

  player    Player     @relation(fields: [playerId], references: [id])
  playerId  String

  present   Boolean    @default(true)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([nightId, playerId], name: "NightAttendance_night_player_unique")
}

model PlayRequest {
  id            String    @id @default(cuid())
  name          String?
  message       String?
  preferredDate DateTime?
  nightId       String?

  createdAt     DateTime  @default(now())
}

model Round {
  id        String      @id @default(cuid())

  night     BouleNight  @relation(fields: [nightId], references: [id])
  nightId   String

  number    Int         // 1, 2, 3

  matches   Match[]
  byes      RoundBye[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model Match {
  id          String       @id @default(cuid())

  night       BouleNight   @relation(fields: [nightId], references: [id])
  nightId     String

  round       Round        @relation(fields: [roundId], references: [id])
  roundId     String

  lane        Int?

  homeScore   Int?
  awayScore   Int?
  status      MatchStatus  @default(SCHEDULED)
  walkoverWinner TeamSide?

  teams       MatchTeam[]
  resultConfirmations MatchResultConfirmation[]
  favorites  Favorite[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model MatchResultConfirmation {
  id        String                     @id @default(cuid())

  match     Match                      @relation(fields: [matchId], references: [id])
  matchId   String

  player    Player                     @relation(fields: [playerId], references: [id])
  playerId  String

  reportedHomeScore Int
  reportedAwayScore Int
  reportedWalkoverSide TeamSide?
  status    ResultConfirmationStatus   @default(PENDING)

  createdAt DateTime                   @default(now())
  updatedAt DateTime                   @updatedAt

  @@unique([matchId, playerId], name: "MatchConfirmation_unique")
}

model RoundBye {
  id        String   @id @default(cuid())

  round     Round    @relation(fields: [roundId], references: [id])
  roundId   String

  player    Player   @relation(fields: [playerId], references: [id])
  playerId  String

  createdAt DateTime @default(now())
}

model MatchTeam {
  id        String    @id @default(cuid())

  match     Match     @relation(fields: [matchId], references: [id])
  matchId   String

  side      TeamSide

  // För laglottning: koppla till ett fast lag
  team      Team?     @relation(fields: [teamId], references: [id])
  teamId    String?

  players   MatchPlayer[]
}

model MatchPlayer {
  id            String      @id @default(cuid())

  matchTeam     MatchTeam   @relation(fields: [matchTeamId], references: [id])
  matchTeamId   String

  player        Player      @relation(fields: [playerId], references: [id])
  playerId      String

  pointsFor     Int         @default(0)
  pointsAgainst Int         @default(0)
  won           Boolean     @default(false)
}

enum MatchStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELED
  WALKOVER
}

enum ResultConfirmationStatus {
  PENDING
  CONFIRMED
  DISPUTED
}

enum TeamSide {
  HOME
  AWAY
}

enum NightType {
  DAY
  EVENING
}

enum DrawMode {
  INDIVIDUAL  // Spelare lottas ihop till nya lag varje runda
  TEAM        // Fasta lag tävlar mot varandra
}

model Team {
  id        String   @id @default(cuid())
  name      String
  
  members   TeamMember[]
  
  // Lag kan kopplas till matcher via MatchTeam
  matchTeams MatchTeam[]
  ranking   Ranking?
  favorites Favorite[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeamMember {
  id        String   @id @default(cuid())
  
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId    String
  
  player    Player   @relation(fields: [playerId], references: [id])
  playerId  String
  
  createdAt DateTime @default(now())
  
  @@unique([teamId, playerId])
}

model Ranking {
  id            String   @id @default(uuid())

  playerId      String?  @unique
  teamId        String?  @unique
  player        Player?  @relation(fields: [playerId], references: [id])
  team          Team?    @relation(fields: [teamId], references: [id])

  simplePoints  Int      @default(0)
  simpleRankPos Int?

  eloRating     Int      @default(1500)
  eloRankPos    Int?

  matchesPlayed Int      @default(0)
  matchesWon    Int      @default(0)

  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
}
